"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[10598],{28453(n,e,t){t.d(e,{R:()=>i,x:()=>s});var o=t(96540);const r={},a=o.createContext(r);function i(n){const e=o.useContext(a);return o.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:i(n.components),o.createElement(a.Provider,{value:e},n.children)}},34319(n,e,t){t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>_});const o=JSON.parse('{"id":"Computer/Programming/Python/openpyxl \u793a\u4f8b","title":"openpyxl \u793a\u4f8b","description":"","source":"@site/vault/Areas/Computer/60_Programming/Python/openpyxl \u793a\u4f8b.md","sourceDirName":"Computer/60_Programming/Python","slug":"/Computer/Programming/Python/openpyxl \u793a\u4f8b","permalink":"/docs/Computer/Programming/Python/openpyxl \u793a\u4f8b","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1769525582000,"frontMatter":{},"sidebar":"computerSidebar","previous":{"title":"Python classmethod and staticmethod","permalink":"/docs/Computer/Programming/Python/Python classmethod and staticmethod"},"next":{"title":"pip","permalink":"/docs/Computer/Programming/Python/pip"}}');var r=t(74848),a=t(28453);const i={},s=void 0,l={},_=[];function c(n){const e={code:"code",pre:"pre",...(0,a.R)(),...n.components};return(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'from openpyxl import load_workbook, Workbook\nimport sys\n\n# \u6c5f\u897f\u7701\u7684\u5e02\u7ea7\u884c\u653f\u533a\u53ca\u5176\u4e0b\u5c5e\u53bf\njiangxi_cities = {\n    "\u5357\u660c\u5e02": ["\u5357\u660c\u53bf", "\u5b89\u4e49\u53bf", "\u8fdb\u8d24\u53bf", "\u9752\u4e91\u8c31\u533a", "\u65b0\u5efa\u533a"],\n    "\u666f\u5fb7\u9547\u5e02": ["\u6d6e\u6881\u53bf", "\u4e50\u5e73\u5e02"],\n    "\u840d\u4e61\u5e02": ["\u83b2\u82b1\u53bf", "\u82a6\u6eaa\u53bf", "\u4e0a\u6817\u53bf", "\u6e58\u4e1c\u533a"],\n    "\u4e5d\u6c5f\u5e02": ["\u4e5d\u6c5f\u53bf", "\u6b66\u5b81\u53bf", "\u4fee\u6c34\u53bf", "\u6c38\u4fee\u53bf", "\u5fb7\u5b89\u53bf", "\u90fd\u660c\u53bf", "\u6e56\u53e3\u53bf", "\u5f6d\u6cfd\u53bf", "\u745e\u660c\u5e02", "\u5171\u9752\u57ce\u5e02", "\u5e90\u5c71\u5e02"],\n    "\u65b0\u4f59\u5e02": ["\u5206\u5b9c\u53bf"],\n    "\u9e70\u6f6d\u5e02": ["\u4f59\u6c5f\u53bf", "\u8d35\u6eaa\u5e02"],\n    "\u8d63\u5dde\u5e02": ["\u8d63\u53bf", "\u4fe1\u4e30\u53bf", "\u5927\u4f59\u53bf", "\u4e0a\u72b9\u53bf", "\u5d07\u4e49\u53bf", "\u5b89\u8fdc\u53bf", "\u9f99\u5357\u53bf", "\u5b9a\u5357\u53bf", "\u5168\u5357\u53bf", "\u5b81\u90fd\u53bf", "\u4e8e\u90fd\u53bf", "\u5174\u56fd\u53bf", "\u4f1a\u660c\u53bf", "\u5bfb\u4e4c\u53bf", "\u77f3\u57ce\u53bf", "\u745e\u91d1\u5e02", "\u5357\u5eb7\u5e02"],\n    "\u5409\u5b89\u5e02": ["\u5409\u5b89\u53bf", "\u5409\u6c34\u53bf", "\u5ce1\u6c5f\u53bf", "\u65b0\u5e72\u53bf", "\u6c38\u4e30\u53bf", "\u6cf0\u548c\u53bf", "\u9042\u5ddd\u53bf", "\u4e07\u5b89\u53bf", "\u5b89\u798f\u53bf", "\u6c38\u65b0\u53bf", "\u4e95\u5188\u5c71\u5e02", "\u5409\u5dde\u533a"],\n    "\u5b9c\u6625\u5e02": ["\u5949\u65b0\u53bf", "\u4e07\u8f7d\u53bf", "\u4e0a\u9ad8\u53bf", "\u5b9c\u4e30\u53bf", "\u9756\u5b89\u53bf", "\u94dc\u9f13\u53bf", "\u4e30\u57ce\u5e02", "\u6a1f\u6811\u5e02", "\u9ad8\u5b89\u5e02"],\n    "\u629a\u5dde\u5e02": ["\u5357\u57ce\u53bf", "\u9ece\u5ddd\u53bf", "\u5357\u4e30\u53bf", "\u5d07\u4ec1\u53bf", "\u4e50\u5b89\u53bf", "\u5b9c\u9ec4\u53bf", "\u91d1\u6eaa\u53bf", "\u8d44\u6eaa\u53bf", "\u4e1c\u4e61\u53bf", "\u5e7f\u660c\u53bf", "\u4e34\u5ddd\u533a"],\n    "\u4e0a\u9976\u5e02": ["\u4e0a\u9976\u53bf", "\u5e7f\u4e30\u53bf", "\u7389\u5c71\u53bf", "\u94c5\u5c71\u53bf", "\u6a2a\u5cf0\u53bf", "\u5f0b\u9633\u53bf", "\u4f59\u5e72\u53bf", "\u9131\u9633\u53bf", "\u4e07\u5e74\u53bf", "\u5a7a\u6e90\u53bf", "\u5fb7\u5174\u5e02", "\u4e09\u6e05\u5c71"]\n}\n\ndef read_excel_file(file_path):\n    try:\n        workbook = load_workbook(filename=file_path)\n        return workbook\n    except Exception as e:\n        print(f"\u8bfb\u53d6Excel\u6587\u4ef6\u65f6\u51fa\u9519: {e}")\n        return None\n\ndef save_excel_file(data, outfile, has_header=True):\n    try:\n        workbook = Workbook()\n        workbook.remove(workbook.active)  # \u5220\u9664\u9ed8\u8ba4\u7684 Sheet\n\n        for sheet_name, rows in data.items():\n            # \u5982\u679c\u6570\u636e\u4e3a\u7a7a\uff0c\u6216\u8005\u6709\u8868\u5934\u4e14\u6570\u636e\u4ec5\u6709\u8868\u5934\uff0c\u5219\u8df3\u8fc7\u521b\u5efa\n            if not rows or (has_header and len(rows) <= 1):\n                print(f"\u5de5\u4f5c\u8868 {sheet_name} \u65e0\u6570\u636e\u6216\u4ec5\u6709\u8868\u5934\uff0c\u8df3\u8fc7\u521b\u5efa")\n                continue\n\n            sheet = workbook.create_sheet(title=sheet_name)\n            # \u76f4\u63a5\u904d\u5386\u6240\u6709\u884c\u5e76\u5199\u5165\n            for row in rows:\n                sheet.append(row)\n\n        workbook.save(filename=outfile)\n        print(f"\u6570\u636e\u5df2\u4fdd\u5b58\u5230\u6587\u4ef6: {outfile}")\n    except Exception as e:\n        print(f"\u4fdd\u5b58Excel\u6587\u4ef6\u65f6\u51fa\u9519: {e}")\n\ndef get_city_by_name(input_str):\n    """\n    \u6839\u636e\u8f93\u5165\u7684\u5b57\u7b26\u4e32\uff08\u53bf\u540d\u6216\u5e02\u540d\uff09\uff0c\u8fd4\u56de\u6240\u5c5e\u7684\u5e02\u540d\u3002\n    :param input_str: \u8f93\u5165\u7684\u5b57\u7b26\u4e32\uff08\u53bf\u540d\u6216\u5e02\u540d\uff09\n    :return: \u6240\u5c5e\u7684\u5e02\u540d\uff0c\u5982\u679c\u4e0d\u5c5e\u4e8e\u4efb\u4f55\u5e02\u5219\u8fd4\u56de None\n    """\n    # \u904d\u5386\u6240\u6709\u5e02\u53ca\u5176\u4e0b\u5c5e\u53bf\n    for city, counties in jiangxi_cities.items():\n        # \u68c0\u67e5\u8f93\u5165\u5b57\u7b26\u4e32\u662f\u5426\u5305\u542b\u5e02\u540d\uff08\u53bb\u6389\u6700\u540e\u4e00\u4e2a\u201c\u5e02\u201d\u5b57\uff09\n        if city in input_str or city[:-1] in input_str:\n            return city\n        # \u68c0\u67e5\u8f93\u5165\u5b57\u7b26\u4e32\u662f\u5426\u5305\u542b\u4e0b\u5c5e\u53bf\u540d\uff08\u53bb\u6389\u6700\u540e\u4e00\u4e2a\u201c\u53bf\u201d\u6216\u201c\u533a\u201d\u5b57\uff09\n        for county in counties:\n            if county in input_str or county[:-1] in input_str:\n                return city\n    # \u5982\u679c\u6ca1\u6709\u5339\u914d\u5230\u4efb\u4f55\u5e02\u6216\u53bf\uff0c\u8fd4\u56de None\n    return None\n\ndef split_sheets_by_column(infile, column_index, start_row=2, outfile="output.xlsx"):\n    try:\n        workbook = read_excel_file(infile)\n        if workbook is None:\n            return None\n\n        sheet = workbook.active\n        header_row = [cell.value for cell in sheet[start_row - 1]]  # \u83b7\u53d6\u8868\u5934\n\n        city_data = {city: [header_row] for city in jiangxi_cities.keys()}  # \u521d\u59cb\u5316\u65f6\u5305\u542b\u8868\u5934\n        city_data["\u672a\u5339\u914d"] = [header_row]  # \u6dfb\u52a0\u672a\u5339\u914d\u6570\u636e\u7684\u952e\uff0c\u5e76\u5305\u542b\u8868\u5934\n\n        for row in sheet.iter_rows(min_row=start_row, values_only=True):\n            value = row[column_index - 1]  # \u5217\u7d22\u5f15\u4ece0\u5f00\u59cb\uff0c\u56e0\u6b64\u9700\u8981\u51cf1\n            if value is None:  # \u5982\u679c\u503c\u4e3a\u7a7a\uff0c\u8df3\u8fc7\u5f53\u524d\u884c\n                continue\n\n            # \u4f7f\u7528 get_city_by_name \u51fd\u6570\u5224\u65ad\u8be5\u503c\u5c5e\u4e8e\u54ea\u4e2a\u5e02\n            city = get_city_by_name(str(value))  # \u786e\u4fdd value \u662f\u5b57\u7b26\u4e32\n            if city:\n                city_data[city].append(row)  # \u6dfb\u52a0\u5230\u5bf9\u5e94\u5e02\u7684\u5217\u8868\u4e2d\n            else:\n                city_data["\u672a\u5339\u914d"].append(row)  # \u672a\u5339\u914d\u5230\u4efb\u4f55\u5e02\uff0c\u6dfb\u52a0\u5230\u201c\u672a\u5339\u914d\u201d\u5217\u8868\n\n        # \u6253\u5370\u6bcf\u4e2a Sheet \u7684\u884c\u6570\uff08\u51cf\u53bb\u8868\u5934\uff09\u5e76\u8ba1\u7b97\u603b\u884c\u6570\n        print("\u6309\u5e02\u5206\u7ec4\u540e\u7684\u884c\u6570\u7edf\u8ba1\uff1a")\n        total_rows = 0  # \u603b\u884c\u6570\n        for city, rows in city_data.items():\n            row_count = len(rows) - 1  # \u51cf\u53bb\u8868\u5934\n            print(f"{city}: {row_count} \u884c")\n            total_rows += row_count  # \u7d2f\u52a0\u603b\u884c\u6570\n\n        print(f"\u5206\u7ec4\u540e\u7684\u603b\u884c\u6570: {total_rows} \u884c")\n\n        save_excel_file(city_data, outfile, has_header=True)\n        return city_data\n    except Exception as e:\n        print(f"\u8bfb\u53d6Excel\u6587\u4ef6\u65f6\u51fa\u9519: {e}")\n        return None\n\ndef read_and_filter_excel(infile, start_row=2):\n    try:\n        workbook = read_excel_file(infile)\n        if workbook is None:\n            return None, None\n\n        # \u5b9a\u4e49\u8fc7\u6ee4\u6761\u4ef6\uff08\u6bcf\u4e2a\u6761\u4ef6\u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u8fd4\u56de (result, reason)\uff09\n        filter_conditions = [\n            lambda row: (row[8] != "\u4e0d\u9650", "\u7b2c9\u5217: \u62db\u8058\u5bf9\u8c61\u4e0d\u4e3a\'\u4e0d\u9650\'"),\n            lambda row: (not (row[9] == "\u4e13\u4e1a\u4e0d\u9650" or any(keyword in row[9].split("\u672c\u79d1\u4e13\u4e1a")[-1] for keyword in ["\u8ba1\u7b97\u673a", "\u8f6f\u4ef6"])), "\u7b2c10\u5217: \u4e13\u4e1a\u4e0d\u7b26\u5408\u8981\u6c42"),\n            lambda row: (row[10] == "\u7855\u58eb\u7814\u7a76\u751f\u53ca\u4ee5\u4e0a\u5b66\u5386", "\u7b2c11\u5217: \u5b66\u5386\u8981\u6c42\u8fc7\u9ad8"),\n            lambda row: ("25\u5468\u5c81\u4ee5\u4e0b" in row[11] or "30\u5468\u5c81\u4ee5\u4e0b" in row[11], "\u7b2c12\u5217: \u5e74\u9f84\u4e0d\u7b26\u5408\u8981\u6c42"),\n            lambda row: (any(keyword in str(row[12]) for keyword in ["\u804c\u4e1a\u8d44\u683c\u8bc1\u4e66", "\u57fa\u5c42\u5de5\u4f5c\u7ecf\u5386", "\u6bd5\u4e1a\u751f", "\u9650\u672c\u53bf", "\u9000\u5f79\u58eb\u5175", "\u7b26\u5408\u4eba\u6c11\u8b66\u5bdf\u5f55\u7528\u6761\u4ef6", "\u9650\u5973\u6027", "\u670d\u52a1\u671f\u6ee1\u4eba\u5458"]), "\u7b2c13\u5217: \u5176\u4ed6\u9650\u5236\u6761\u4ef6\u4e0d\u7b26\u5408\u8981\u6c42"),\n            lambda row: (any(keyword in str(row[15]) for keyword in ["\u8d44\u683c\u8bc1\u4e66", "\u6cd5\u5f8b", "\u4f1a\u8ba1", "\u6b8b\u75be\u4eba", "\u7572\u65cf"]), "\u7b2c16\u5217: \u5176\u4ed6\u9650\u5236\u6761\u4ef6\u4e0d\u7b26\u5408\u8981\u6c42"),\n        ]\n\n        all_data = {}  # \u4fdd\u7559\u7684\u884c\n        all_excluded_data = {}  # \u8fc7\u6ee4\u6389\u7684\u884c\n\n        for sheet_name in workbook.sheetnames:\n            sheet = workbook[sheet_name]\n            print(f"\u6b63\u5728\u5904\u7406\u5de5\u4f5c\u8868: {sheet.title}")\n\n            header_row = [cell.value for cell in sheet[start_row-1]]  # \u83b7\u53d6\u8868\u5934\n\n            data = [header_row]  # \u4fdd\u7559\u7684\u884c\uff0c\u5305\u542b\u8868\u5934\n            excluded_data = [header_row + ["\u6392\u9664\u539f\u56e0"]]  # \u8fc7\u6ee4\u6389\u7684\u884c\uff0c\u5305\u542b\u8868\u5934\u548c\u6392\u9664\u539f\u56e0\n\n            for row in sheet.iter_rows(min_row=start_row, values_only=True):  # \u4ece\u6307\u5b9a\u884c\u5f00\u59cb\u8bfb\u53d6\u6570\u636e\n                exclusion_reason = []  # \u7528\u4e8e\u5b58\u50a8\u6392\u9664\u539f\u56e0\n\n                for condition in filter_conditions:\n                    result, reason = condition(row)  # \u8c03\u7528\u8fc7\u6ee4\u6761\u4ef6\u51fd\u6570\uff0c\u83b7\u53d6\u7ed3\u679c\u548c\u539f\u56e0\n                    if result:\n                        exclusion_reason.append(reason)  # \u6dfb\u52a0\u6392\u9664\u539f\u56e0\n\n                if exclusion_reason:\n                    # \u5c06\u6392\u9664\u539f\u56e0\u9644\u52a0\u5230\u884c\u5c3e\n                    excluded_data.append(list(row) + ["; ".join(exclusion_reason)])\n                else:\n                    data.append(row)\n\n            print(f"\u5de5\u4f5c\u8868 {sheet.title} \u7b5b\u9009\u540e\u7684\u603b\u884c\u6570: {len(data) - 1}")  # \u51cf\u53bb\u8868\u5934\n            print(f"\u5de5\u4f5c\u8868 {sheet.title} \u8fc7\u6ee4\u6389\u7684\u603b\u884c\u6570: {len(excluded_data) - 1}")  # \u51cf\u53bb\u8868\u5934\n\n            all_data[sheet_name] = data\n            all_excluded_data[sheet_name] = excluded_data\n\n        total_kept = sum(len(rows) - 1 for rows in all_data.values())\n        total_excluded = sum(len(rows) - 1 for rows in all_excluded_data.values())\n        print(f"\u6240\u6709\u4fdd\u7559\u7684\u603b\u884c\u6570: {total_kept}")\n        print(f"\u6240\u6709\u8fc7\u6ee4\u6389\u7684\u603b\u884c\u6570: {total_excluded}")\n        \n        save_excel_file(all_data, "\u6240\u6709\u4fdd\u7559\u7684\u884c.xlsx", has_header=True)\n        # \u4fdd\u5b58\u8fc7\u6ee4\u6389\u7684\u6570\u636e\uff08\u9ed8\u8ba4\u5c06\u9996\u884c\u89c6\u4e3a\u8868\u5934\uff09\n        save_excel_file(all_excluded_data, "\u6240\u6709\u8fc7\u6ee4\u6389\u7684\u884c.xlsx", has_header=True)\n\n        return all_data, all_excluded_data\n    except Exception as e:\n        print(f"\u8bfb\u53d6Excel\u6587\u4ef6\u65f6\u51fa\u9519: {e}")\n        return None, None\n\ndef main():\n    if len(sys.argv) < 2:\n        print("\u8bf7\u63d0\u4f9bExcel\u6587\u4ef6\u8def\u5f84\uff01")\n        print("\u7528\u6cd5: python script.py <\u6587\u4ef6\u8def\u5f84>")\n        sys.exit(1)\n\n    file_path = sys.argv[1]  # \u6587\u4ef6\u8def\u5f84\n    split_sheets_file = "split.xlsx"\n\n    split_sheets_by_column(file_path, 3, start_row=4, outfile=split_sheets_file)\n\n    read_and_filter_excel(split_sheets_file)\n    \n\nif __name__ == "__main__":\n    main()\n'})})}function d(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(c,{...n})}):c(n)}}}]);